<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Complete AI Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.loading {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 15px;
            padding: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 70vh;
        }

        .chat-header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #4f46e5;
        }

        .message.ai .message-avatar {
            background: #10b981;
        }

        .message-content {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #4f46e5;
            color: white;
        }

        .message-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            margin: 20px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .send-button {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .send-button:hover {
            background: #3730a3;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #374151;
            font-size: 1.1em;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #4f46e5;
            background: #f8faff;
        }

        .upload-area.dragover {
            border-color: #4f46e5;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 32px;
            color: #9ca3af;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #6b7280;
            font-size: 14px;
        }

        .file-input {
            display: none;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-button {
            flex: 1;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .mode-button.active {
            border-color: #4f46e5;
            background: #f0f4ff;
            color: #4f46e5;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-button {
            background: #f3f4f6;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .action-button:hover {
            background: #e5e7eb;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .record-button {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .record-button.recording {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .audio-player {
            flex: 1;
            max-width: 200px;
        }

        .file-preview {
            margin-top: 15px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
            color: #6b7280;
        }

        .action-button.loading {
            background: #f59e0b;
            color: white;
            animation: pulse 2s infinite;
        }

        .action-button.success {
            background: #10b981;
            color: white;
        }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        .model-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .model-loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }

        .model-loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .chat-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Complete AI Engine</h1>
            <p>Text ‚Ä¢ Vision ‚Ä¢ Audio ‚Ä¢ All in One</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="connectionText">Checking connection...</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="modelStatus"></div>
                <span id="modelText">Models not loaded</span>
            </div>
            <div class="status-item">
                <span>üíæ RAM: <span id="ramUsage">--</span></span>
            </div>
            <div class="status-item">
                <span>üí¨ Messages: <span id="messageCount">0</span></span>
            </div>
            <div class="status-item">
                <button class="action-button" id="loadModelsBtn" onclick="loadModels()">üß† Load Models</button>
                <button class="action-button" onclick="clearMemory()">üóëÔ∏è Clear Chat</button>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-container">
                <div class="chat-header">
                    <h2>üí¨ AI Chat</h2>
                    <p>Type, upload images, or record voice messages</p>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <div>Welcome! I'm your AI assistant, but I need to load my models first. Please click the "üß† Load Models" button above to get started.</div>
                            <div class="message-meta">Just now</div>
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">ü§ñ</div>
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="input-field" 
                            id="messageInput" 
                            placeholder="Type your message here..."
                            rows="1"></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            ‚û§
                        </button>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>üìÅ File Upload</h3>
                    
                    <div class="mode-selector">
                        <div class="mode-button active" data-mode="image">üñºÔ∏è Image</div>
                        <div class="mode-button" data-mode="audio">üéµ Audio</div>
                    </div>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìé</div>
                        <div class="upload-text">
                            <strong>Drag & drop files here</strong><br>
                            or click to browse
                        </div>
                    </div>
                    
                    <input type="file" class="file-input" id="fileInput" accept="image/*">
                    
                    <div class="file-preview" id="filePreview" style="display: none;"></div>
                    
                    <input type="text" class="input-field" id="fileQuestion" 
                           placeholder="Ask something about the file..." style="margin-top: 10px;">
                </div>

                <div class="panel">
                    <h3>üé§ Voice Chat</h3>
                    
                    <div class="audio-controls">
                        <button class="record-button" id="recordButton" onclick="toggleRecording()">
                            üé§
                        </button>
                        <audio class="audio-player" id="audioPlayer" controls style="display: none;"></audio>
                    </div>
                    
                    <div class="upload-text" style="margin-top: 10px; font-size: 12px;">
                        Click to start/stop recording or upload audio file
                    </div>
                </div>

                <div class="panel">
                    <h3>‚ö° Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="action-button" onclick="quickAction('Explain this concept in simple terms')">
                            üí° Explain Simply
                        </button>
                        <button class="action-button" onclick="quickAction('Summarize the key points')">
                            üìã Summarize
                        </button>
                        <button class="action-button" onclick="quickAction('What questions can I ask about this?')">
                            ‚ùì Suggest Questions
                        </button>
                        <button class="action-button" onclick="forceCleanup()">
                            üßπ Clean RAM
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Loading Overlay -->
    <div class="model-loading-overlay" id="modelLoadingOverlay">
        <div class="model-loading-content">
            <h3>üß† Loading AI Models</h3>
            <div class="model-loading-spinner"></div>
            <p id="loadingStatus">Preparing AI models...</p>
            <p style="font-size: 14px; color: #6b7280; margin-top: 15px;">
                This may take 1-3 minutes on first load.<br>
                Models are being downloaded and initialized.
            </p>
        </div>
    </div>

    <script>
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentMode = 'image';
        let isLoading = false;
        let modelsLoaded = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            setupEventListeners();
            updateUIState();
            
            // Check status every 30 seconds
            setInterval(checkConnection, 30000);
        });

        function setupEventListeners() {
            // File upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // Mode selector
            document.querySelectorAll('.mode-button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.mode-button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    updateFileInput();
                });
            });
            
            // Message input
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }

        function updateUIState() {
            const chatContainer = document.querySelector('.chat-container');
            const sidebar = document.querySelector('.sidebar');
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');
            const loadModelsBtn = document.getElementById('loadModelsBtn');
            
            if (!modelsLoaded) {
                // Disable chat functionality
                chatContainer.classList.add('disabled');
                sidebar.classList.add('disabled');
                sendButton.disabled = true;
                messageInput.disabled = true;
                messageInput.placeholder = "Load models first to start chatting...";
                
                // Show load models button
                loadModelsBtn.style.display = 'block';
                loadModelsBtn.textContent = 'üß† Load Models';
                loadModelsBtn.className = 'action-button';
            } else {
                // Enable chat functionality
                chatContainer.classList.remove('disabled');
                sidebar.classList.remove('disabled');
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.placeholder = "Type your message here...";
                
                // Hide/update load models button
                loadModelsBtn.textContent = '‚úÖ Models Loaded';
                loadModelsBtn.className = 'action-button success';
                loadModelsBtn.onclick = null;
            }
        }
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            if (currentMode === 'image') {
                fileInput.accept = 'image/*';
                uploadArea.querySelector('.upload-icon').textContent = 'üñºÔ∏è';
                uploadArea.querySelector('.upload-text').innerHTML = 
                    '<strong>Drag & drop images here</strong><br>JPG, PNG, GIF supported';
            } else if (currentMode === 'audio') {
                fileInput.accept = 'audio/*';
                uploadArea.querySelector('.upload-icon').textContent = 'üéµ';
                uploadArea.querySelector('.upload-text').innerHTML = 
                    '<strong>Drag & drop audio here</strong><br>WAV, MP3, M4A supported';
            }
        

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const preview = document.getElementById('filePreview');
            preview.style.display = 'block';
            preview.innerHTML = `
                <strong>üìÅ Selected:</strong> ${file.name}<br>
                <strong>üì¶ Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                <strong>üè∑Ô∏è Type:</strong> ${file.type || 'Unknown'}
            `;
            
            // Store file for upload
            window.selectedFile = file;
        }

        async function uploadFile() {
            if (!window.selectedFile) {
                alert('Please select a file first');
                return;
            }

            if (!modelsLoaded) {
                alert('Please load the AI models first!');
                return;
            }

            const question = document.getElementById('fileQuestion').value || 
                           (currentMode === 'image' ? 'What do you see in this image?' : 'What is in this audio?');

            setLoading(true);
            
            try {
                const formData = new FormData();
                formData.append('file', window.selectedFile);
                
                let url;
                if (currentMode === 'image') {
                    url = '/analyze_image?question=' + encodeURIComponent(question) + '&remember=true';
                } else if (currentMode === 'audio') {
                    url = '/voice_conversation?respond_with_voice=true&remember=true';
                }

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                // Add user message
                addMessage('user', `[${currentMode.toUpperCase()}: ${window.selectedFile.name}] ${question}`);
                
                // Add AI response
                if (currentMode === 'image') {
                    addMessage('ai', result.response);
                } else if (currentMode === 'audio') {
                    addMessage('ai', `I heard: "${result.user_speech}"\n\nMy response: ${result.ai_response}`);
                    
                    // Play AI voice response if available
                    if (result.download_url) {
                        playAudio(result.download_url);
                    }
                }
                
                // Clear file selection
                clearFileSelection();
                
            } catch (error) {
                addMessage('ai', `Sorry, I couldn't process that file. Error: ${error.message}`);
            }
            
            setLoading(false);
        }

        function clearFileSelection() {
            document.getElementById('fileInput').value = '';
            document.getElementById('fileQuestion').value = '';
            document.getElementById('filePreview').style.display = 'none';
            window.selectedFile = null;
        }

        async function sendMessage() {
            if (!modelsLoaded) {
                alert('Please load the AI models first!');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !window.selectedFile) return;
            
            // If file is selected, upload it instead
            if (window.selectedFile) {
                await uploadFile();
                return;
            }
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Add user message
            addMessage('user', message);
            
            // Show typing indicator
            showTyping(true);
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: message,
                        remember: true
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Add AI response
                addMessage('ai', result.response);
                
            } catch (error) {
                addMessage('ai', `Sorry, I encountered an error: ${error.message}`);
            }
            
            showTyping(false);
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div>${content}</div>
                    <div class="message-meta">${time}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update message count
            const messageCount = document.querySelectorAll('.message').length;
            document.getElementById('messageCount').textContent = messageCount;
        }

        function showTyping(show) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = show ? 'flex' : 'none';
            
            if (show) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function setLoading(loading) {
            isLoading = loading;
            const sendButton = document.getElementById('sendButton');
            const container = document.querySelector('.chat-container');
            
            sendButton.disabled = loading;
            if (loading) {
                container.classList.add('loading');
                showTyping(true);
            } else {
                container.classList.remove('loading');
                showTyping(false);
            }
        }

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processRecordedAudio(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const button = document.getElementById('recordButton');
                button.classList.add('recording');
                button.textContent = '‚èπÔ∏è';
                
            } catch (error) {
                alert('Could not access microphone: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                const button = document.getElementById('recordButton');
                button.classList.remove('recording');
                button.textContent = 'üé§';
            }
        }

        async function processRecordedAudio(audioBlob) {
            if (!modelsLoaded) {
                alert('Please load the AI models first!');
                return;
            }

            setLoading(true);
            
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.wav');
                
                const response = await fetch('/voice_conversation?respond_with_voice=true&remember=true', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Add messages
                addMessage('user', `üé§ Voice: "${result.user_speech}"`);
                addMessage('ai', result.ai_response);
                
                // Play AI response
                if (result.download_url) {
                    playAudio(result.download_url);
                }
                
            } catch (error) {
                addMessage('ai', `Sorry, I couldn't process your voice message: ${error.message}`);
            }
            
            setLoading(false);
        }

        function playAudio(url) {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = url;
            audioPlayer.style.display = 'block';
            audioPlayer.play();
        }

        function quickAction(prompt) {
            document.getElementById('messageInput').value = prompt;
            sendMessage();
        }

        async function checkConnection() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                const statusDot = document.getElementById('connectionStatus');
                const statusText = document.getElementById('connectionText');
                const ramUsage = document.getElementById('ramUsage');
                const modelStatusDot = document.getElementById('modelStatus');
                const modelText = document.getElementById('modelText');
                
                // Connection status
                statusDot.className = 'status-dot';
                statusText.textContent = 'Connected';
                ramUsage.textContent = health.ram;
                
                // Model status
                const visionLoaded = health.models?.vision_language === 'loaded';
                const speechLoaded = health.models?.speech_recognition === 'loaded';
                const ttsLoaded = health.models?.text_to_speech === 'available';
                
                if (visionLoaded && speechLoaded && ttsLoaded) {
                    modelsLoaded = true;
                    modelStatusDot.className = 'status-dot';
                    modelText.textContent = 'All models loaded';
                } else if (visionLoaded || speechLoaded || ttsLoaded) {
                    modelsLoaded = true; // At least vision model for basic chat
                    modelStatusDot.className = 'status-dot loading';
                    modelText.textContent = 'Partially loaded';
                } else {
                    modelsLoaded = false;
                    modelStatusDot.className = 'status-dot error';
                    modelText.textContent = 'Models not loaded';
                }
                
                updateUIState();
                
            } catch (error) {
                const statusDot = document.getElementById('connectionStatus');
                const statusText = document.getElementById('connectionText');
                
                statusDot.className = 'status-dot error';
                statusText.textContent = 'Disconnected';
                
                modelsLoaded = false;
                updateUIState();
            }
        }

        async function loadModels() {
            const loadModelsBtn = document.getElementById('loadModelsBtn');
            const overlay = document.getElementById('modelLoadingOverlay');
            const loadingStatus = document.getElementById('loadingStatus');
            
            // Show loading overlay
            overlay.style.display = 'flex';
            loadModelsBtn.className = 'action-button loading';
            loadModelsBtn.textContent = '‚è≥ Loading...';
            
            const statusMessages = [
                'Initializing AI models...',
                'Loading vision-language model...',
                'Loading speech recognition...',
                'Loading text-to-speech...',
                'Optimizing for your system...',
                'Almost ready...'
            ];
            
            let statusIndex = 0;
            const statusInterval = setInterval(() => {
                if (statusIndex < statusMessages.length) {
                    loadingStatus.textContent = statusMessages[statusIndex];
                    statusIndex++;
                }
            }, 3000);
            
            try {
                const response = await fetch('/load_models', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                clearInterval(statusInterval);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Success!
                modelsLoaded = true;
                loadingStatus.textContent = '‚úÖ Models loaded successfully!';
                
                // Update chat with success message
                setTimeout(() => {
                    overlay.style.display = 'none';
                    updateUIState();
                    
                    // Clear initial message and add success message
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="message ai">
                            <div class="message-avatar">ü§ñ</div>
                            <div class="message-content">
                                <div>üéâ Great! All my AI models are now loaded and ready. I can help you with:</div>
                                <div style="margin: 10px 0;">
                                    ‚Ä¢ üí¨ <strong>Text conversations</strong> - Ask me anything!<br>
                                    ‚Ä¢ üñºÔ∏è <strong>Image analysis</strong> - Upload photos for analysis<br>
                                    ‚Ä¢ üé§ <strong>Voice chat</strong> - Record or upload audio<br>
                                    ‚Ä¢ üîä <strong>Voice responses</strong> - I can speak back to you
                                </div>
                                <div>What would you like to try first?</div>
                                <div class="message-meta">Just now</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('messageCount').textContent = '1';
                }, 1500);
                
            } catch (error) {
                clearInterval(statusInterval);
                loadingStatus.textContent = '‚ùå Failed to load models: ' + error.message;
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    loadModelsBtn.className = 'action-button';
                    loadModelsBtn.textContent = 'üîÑ Retry Loading';
                    
                    addMessage('ai', `Sorry, I couldn't load my models: ${error.message}. Please try clicking "Load Models" again.`);
                }, 3000);
            }
        }

        async function clearMemory() {
            if (confirm('Clear all chat history? This cannot be undone.')) {
                try {
                    await fetch('/clear_memory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ confirm: true })
                    });
                    
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="message ai">
                            <div class="message-avatar">ü§ñ</div>
                            <div class="message-content">
                                <div>Chat history cleared! How can I help you today?</div>
                                <div class="message-meta">Just now</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('messageCount').textContent = '1';
                    
                } catch (error) {
                    alert('Failed to clear memory: ' + error.message);
                }
            }
        }

        async function forceCleanup() {
            try {
                const response = await fetch('/force_cleanup', { method: 'POST' });
                const result = await response.json();
                
                addMessage('ai', `üßπ RAM cleanup completed! Current usage: ${result.current_ram_usage}`);
                
                // Update RAM display
                setTimeout(checkConnection, 1000);
                
            } catch (error) {
                addMessage('ai', 'Failed to clean RAM: ' + error.message);
            }
        }
    </script>
</body>
</html>